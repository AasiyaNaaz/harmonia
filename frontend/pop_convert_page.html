<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Harmonica ‚Äì AI Pop Style Converter</title>
    <style>
/* ========= GLOBAL THEME (NIGHT/PURPLE) ========= */
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #0a001a;
    color: white;
    overflow-x: hidden;
    transition: background-color 0.4s ease, background-image 0.4s ease;
}

/* --- PROMINENT EMOJI BACKGROUND --- */
#emoji-background-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -2;
    overflow: hidden;
    display: flex; 
    flex-wrap: wrap;
    align-content: flex-start;
    justify-content: space-around; 
    background: #0a001a;
    pointer-events: none;
}

.background-emoji {
    position: absolute;
    font-size: 35px;
    opacity: 0.15;
    text-align: center;
    line-height: 1;
    transition: opacity 0.5s ease, transform 0.5s ease;
    animation: pulse-fade 10s ease-in-out infinite alternate;
}
@keyframes pulse-fade {
    0% { transform: scale(0.9); opacity: 0.1; }
    100% { transform: scale(1.1); opacity: 0.25; }
}

/* ========= LAYOUT & TITLE (EXISTING) ========= */
.container {
    width: 95%;
    max-width: 900px; 
    margin: auto;
    padding: 40px 0 80px;
}
h1 {
    text-align: center;
    font-size: 38px;
    margin-bottom: 25px;
    letter-spacing: 2px;
    color: #b380ff; 
    text-shadow: 0 0 12px #9933ff;
    transition: color 0.4s, text-shadow 0.4s;
}

/* --- 3x2 GRID LAYOUT (EXISTING) --- */
.grid-row { display: flex; gap: 20px; margin-bottom: 20px; }
.grid-item { flex: 1; min-width: 0; }
.full-width-card { width: 100%; }

/* ========= CARD (GRADIENT BORDER) ========= */
.card {
    background: rgba(255,255,255,0.05);
    border: 1px solid transparent; 
    padding: 20px 25px;
    border-radius: 16px;
    backdrop-filter: blur(8px);
    box-shadow: 0 0 25px rgba(0,0,0,0.3);
    position: relative; 
    overflow: hidden; 
    transition: all 0.4s ease-in-out; 
    min-height: 120px;
    display: flex; 
    flex-direction: column;
    justify-content: flex-start;
}
.card::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 16px;
    padding: 2px;
    background: linear-gradient(45deg, #ff4de1, #7a00ff, #00d4ff);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    z-index: -1;
    transition: opacity 0.4s ease;
}
.card:hover::before { opacity: 0.8; }
.card h3 {
    font-weight: 500;
    margin-top: 0;
    margin-bottom: 12px;
    color: #b380ff;
    text-shadow: 0 0 6px #8000ff;
    transition: color 0.4s, text-shadow 0.4s;
}
#mixerBg { display: none; }

/* ========= INPUTS & BUTTONS (VISUALLY APPEALING) ========= */

input[type="file"] {
    margin-top: 10px;
    background: linear-gradient(45deg, #2e004d, #1a0133);
    border: 1px solid #7a00ff; 
    color: white;
    padding: 12px 8px;
    border-radius: 12px;
    width: 100%;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
    font-weight: 500;
    display: flex; 
    align-items: center;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
input[type="file"]::file-selector-button {
    background: linear-gradient(90deg, #ff4de1, #b380ff);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    margin-right: 15px;
    transition: all 0.3s;
    font-weight: 600;
}

/* Appealing Select/Dropdown (FIXED INVISIBILITY) */
select {
    appearance: none;
    background: linear-gradient(45deg, #2e004d, #1a0133) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23b380ff" d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
    background-size: 18px;
    border: 1px solid #7a00ff; 
    color: rgb(134, 27, 90) !important;
    padding: 12px 15px; 
    border-radius: 12px;
    width: 100%;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
    font-weight: 500;
    text-shadow: 0 0 2px rgba(0, 0, 0, 0.7);
}
select option {
    background: #1a0133; 
    color: white; 
}
select:focus { outline: none; box-shadow: 0 0 10px #ff4de1; }

/* Buttons (GRADIENT) */
button {
    background: linear-gradient(135deg, #ff4de1, #7a00ff, #00c3ff);
    border: none;
    padding: 14px 20px;
    font-size: 16px;
    color: white;
    border-radius: 12px;
    cursor: pointer;
    transition: 0.25s;
    width: 100%;
    margin-top: 12px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    box-shadow: 0 5px 15px rgba(122, 0, 255, 0.4);
}
button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(187, 107, 255, 0.6);
}

/* Radio Buttons */
label input[type="radio"] { accent-color: #b380ff; }
label { display: flex; align-items: center; margin-bottom: 8px; font-weight: 400; transition: color 0.3s; }

/* ========= VISUALIZER & MIXER ITEMS (EXISTING) ========= */
#visualizer { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; padding: 0 5px; opacity: 0; transition: opacity 0.3s ease; height: 35px; }
.vis-bar { background-color: #b380ff; width: 4px; height: 5px; margin: 0 1px; border-radius: 1px; transition: background-color 0.4s, height 0.08s; transform-origin: bottom; }
.mixer-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 16px; font-weight: 500; }
.instrument-icon { font-size: 24px; margin-right: 10px; transition: transform 0.1s; }
.animate-glow { text-shadow: 0 0 10px #ff00c3, 0 0 20px #7a00ff; animation: bounce-scale 0.5s ease; }
@keyframes bounce-scale { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1) translateY(-3px); } }

/* ========= STATUS & RATING POPUP (EXISTING) ========= */
#status { background: #331144; padding: 6px 12px; border-radius: 10px; margin-left: 10px; border: 1px solid #663399; }
#rate-chaos-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); z-index: 1000; display: none; place-items: center; }
.rate-chaos-content { background: radial-gradient(circle at center, #2e004d, #1a0133); padding: 40px; border-radius: 20px; text-align: center; border: 2px solid #b380ff; box-shadow: 0 0 30px #9933ff; }
.rate-option:hover { transform: scale(1.2); text-shadow: 0 0 15px #ffffff; }

/* ========= STYLE SWITCH THEMES (EXISTING) ========= */
/* ... (theme styles remain the same for color changes on theme change) ... */
    </style>
</head>

<body>
<div id="rate-chaos-popup">
    <div class="rate-chaos-content">
        <span class="rate-metal">üòà</span>
        <h2>Rate the chaos ‚Äî how METAL was that?</h2>
        <div>
            <span class="rate-option" data-rating="1">üéª</span>
            <span class="rate-option" data-rating="2">ü™ï</span>
            <span class="rate-option" data-rating="3">ü•Å</span>
            <span class="rate-option" data-rating="4">üé∏</span>
            <span class="rate-option rate-metal" data-rating="5">üî•üî•üî•</span>
        </div>
        <p style="margin-top: 25px; opacity: 0.7;">(Select an emoji to close)</p>
    </div>
</div>

<div id="emoji-background-container"></div>

<div class="container">

<h1>POP STYLE CONVERTER üéµ</h1>

<div class="grid-row">
    <div class="grid-item">
        <div class="card">
            <h3> Upload Song</h3>
            <input type="file" id="songFile">
            <button id="uploadBtn" type="button">Upload Song</button>
        </div>
    </div>
    <div class="grid-item">
        <div class="card">
            <h3>Choose Style</h3>
            <select id="styleSelect">
                <option value="poprock">Pop Rock</option>
                <option value="edm">EDM Pop</option>
                <option value="bollywood">Bollywood Chill</option>
                <option value="lofi">Lo-Fi Pop</option>
            </select>
        </div>
    </div>
</div>

<div class="grid-row">
    <div class="grid-item">
        <div class="card">
            <h3> Autotune / Vocal Style</h3>
            <label><input type="radio" name="autotune" value="subtle" checked> Subtle (natural)</label><br>
            <label><input type="radio" name="autotune" value="medium"> Medium (clear)</label><br>
            <label><input type="radio" name="autotune" value="hard"> Hard (T-Pain)</label><br>
            <label><input type="radio" name="autotune" value="all"> Generate ALL</label>
        </div>
    </div>
    <div class="grid-item">
        <div class="card">
            <h3> Run Arrangement</h3>
            <button id="runBtn">‚ú® Arrange Song ‚ú®</button>
            <span id="status">idle</span>

            <div id="progress-container">
                <div id="progress-text">Analyzing Song... 0%</div>
                <div id="progress-bar"><div id="progress-fill"></div></div>
            </div>
        </div>
    </div>
</div>

<div class="grid-row">
    <div class="grid-item full-width-card">
        <div class="card" id="mixer-card">
            <h3> Instrument Mixer</h3>

            <div class="mixer-item">
                <span class="instrument-icon" data-instrument="piano">üéπ</span>
                Piano
                <input type="range" min="0" max="2" step="0.1" value="1" id="mixPiano" data-instrument-name="piano">
            </div>
            <div class="mixer-item">
                <span class="instrument-icon" data-instrument="guitar">üé∏</span>
                Guitar
                <input type="range" min="0" max="2" step="0.1" value="1" id="mixGuitar" data-instrument-name="guitar">
            </div>
            <div class="mixer-item">
                <span class="instrument-icon" data-instrument="bass">üîä</span>
                Bass
                <input type="range" min="0" max="2" step="0.1" value="1" id="mixBass" data-instrument-name="bass">
            </div>
            <div class="mixer-item">
                <span class="instrument-icon" data-instrument="synth">üéõ</span>
                Synth
                <input type="range" min="0" max="2" step="0.1" value="1" id="mixSynth" data-instrument-name="synth">
            </div>
            <div class="mixer-item">
                <span class="instrument-icon" data-instrument="drums">ü•Å</span>
                Drums
                <input type="range" min="0" max="2" step="0.1" value="1" id="mixDrums" data-instrument-name="drums">
            </div>
        </div>
    </div>
</div>

<div class="grid-row">
    <div class="grid-item full-width-card">
        <div class="card">
            <h3> Outputs</h3>
            <div id="visualizer">
                </div>
            <div id="output"></div>
        </div>
    </div>
</div>

</div>

<script>
/* ===========================
    GLOBALS
=========================== */
const API = "http://127.0.0.1:8000";
let songPath = "";

const visualizer = document.getElementById("visualizer");
const progressContainer = document.getElementById("progress-container");
const progressFill = document.getElementById("progress-fill");
const progressText = document.getElementById("progress-text");
const styleSelect = document.getElementById("styleSelect");
const rateChaosPopup = document.getElementById("rate-chaos-popup");
const emojiBackgroundContainer = document.getElementById('emoji-background-container');

let analyser, audioSource, audioContext;
const BAR_COUNT = 30; 
const visBars = [];

// STRICTLY USE ONLY THESE FIVE EMOJIS for the background
const BACKGROUND_EMOJIS = ['üéπ', 'üé∏', 'üîä', 'üéõ', 'ü•Å'];

// Map instrument names to their corresponding emoji
const INSTRUMENT_EMOJIS = {
    'piano': 'üéπ',
    'guitar': 'üé∏',
    'bass': 'üîä',
    'synth': 'üéõ',
    'drums': 'ü•Å',
};
const INSTRUMENT_NAMES = ['piano', 'guitar', 'bass', 'synth', 'drums'];

/* ===========================
    BACKGROUND EMOJI SETUP (FINAL REVISION)
=========================== */

function createBackgroundEmojis() {
    emojiBackgroundContainer.innerHTML = ''; // Clear old emojis

    // 1. Calculate target emoji count for each instrument based on its volume (0-2)
    const instrumentCounts = {};
    let totalEmojiCount = 0;
    const maxVolume = 2.0; 
    const scaleFactor = 70; // Adjust this number to change the overall density (70 = max 70*5=350 emojis)

    INSTRUMENT_NAMES.forEach(name => {
        const volume = parseFloat(document.getElementById(`mix${name.charAt(0).toUpperCase() + name.slice(1)}`).value);
        // Ensure volume is not negative and cap it
        const normalizedVolume = Math.min(Math.max(volume, 0), maxVolume); 
        
        // Count is proportional: (Volume / MaxVolume) * ScaleFactor
        const count = Math.round((normalizedVolume / maxVolume) * scaleFactor);
        instrumentCounts[name] = count;
        totalEmojiCount += count;
    });

    // 2. Build the final array of emojis
    let emojis = [];
    INSTRUMENT_NAMES.forEach(name => {
        const emoji = INSTRUMENT_EMOJIS[name];
        for (let i = 0; i < instrumentCounts[name]; i++) {
            emojis.push(emoji);
        }
    });

    // 3. Shuffle and append to container
    emojis.sort(() => Math.random() - 0.5); 
    
    emojis.forEach(emojiText => {
        const emoji = document.createElement('span');
        emoji.className = 'background-emoji';
        emoji.textContent = emojiText;
        
        // Random positioning (essential for the spread effect)
        emoji.style.left = `${Math.random() * 100}%`;
        emoji.style.top = `${Math.random() * 100}%`;
        emoji.style.fontSize = `${Math.random() * 20 + 30}px`;
        emoji.style.animationDelay = `-${Math.random() * 10}s`;
        emojiBackgroundContainer.appendChild(emoji);
    });
}

// Initial visualizer bar creation
for (let i = 0; i < BAR_COUNT; i++) {
    const bar = document.createElement("div");
    bar.className = "vis-bar";
    visualizer.appendChild(bar);
    visBars.push(bar);
}

// Initial background render & resize listener
window.addEventListener('load', createBackgroundEmojis);
window.addEventListener('resize', createBackgroundEmojis);


/* ===========================
    AUDIO VISUALIZER (MOCKUP)
=========================== */
function toggleVisualizer(isVisible) { visualizer.style.opacity = isVisible ? 1 : 0; }

function setupAudioVisualizer(audioElement) {
    if (!audioContext || audioContext.state === 'closed') { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
    if (audioContext.state === 'suspended') { audioContext.resume(); }

    if (!analyser) {
        audioSource = audioContext.createMediaElementSource(audioElement);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256; 
        audioSource.connect(analyser);
        analyser.connect(audioContext.destination);
    }
    animateVisualizer();
    toggleVisualizer(true);
    audioElement.onpause = () => toggleVisualizer(false);
    audioElement.onplay = () => toggleVisualizer(true);
    audioElement.onended = () => toggleVisualizer(false);
}

function animateVisualizer() {
    if (!analyser) {
         requestAnimationFrame(animateVisualizer);
         const height = (Math.sin(Date.now() / 100) + 1) * 20 + 5; 
         visBars.forEach(bar => { bar.style.height = `${height}%`; });
         return;
    }
    requestAnimationFrame(animateVisualizer);
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteFrequencyData(dataArray);
    const step = Math.floor(bufferLength / BAR_COUNT);
    for (let i = 0; i < BAR_COUNT; i++) {
        const value = dataArray[i * step] || 0; 
        const height = (value / 255) * 90 + 5; 
        visBars[i].style.height = `${height}%`;
    }
}

/* ===========================
    INSTRUMENT MIXER ANIMATION & BACKGROUND DENSITY
=========================== */

document.querySelectorAll('.mixer-item input[type="range"]').forEach(input => {
    input.addEventListener('input', (e) => {
        const icon = input.closest('.mixer-item').querySelector('.instrument-icon');
        const volume = parseFloat(e.target.value);
        
        // Icon animation
        icon.style.transform = `scale(${1 + volume * 0.1}) translateY(-${volume * 3}px)`;
        
        // Update proportional background emojis
        createBackgroundEmojis(); 
    });

    input.addEventListener('change', (e) => {
        const icon = input.closest('.mixer-item').querySelector('.instrument-icon');
        
        // Reset transform, trigger glow/jump
        icon.style.transform = 'scale(1) translateY(0)'; 
        icon.classList.add('animate-glow');
        setTimeout(() => icon.classList.remove('animate-glow'), 500);
    });
});

/* ===========================
    STYLE SWITCHING (EXISTING)
=========================== */
const STYLE_THEMES = {
    'poprock': 'theme-poprock', 'edm': 'theme-edm',
    'bollywood': 'theme-bollywood', 'lofi': 'theme-lofi'
};

styleSelect.addEventListener('change', (e) => {
    const newStyle = e.target.value;
    const body = document.body;

    Object.values(STYLE_THEMES).forEach(c => body.classList.remove(c));
    body.classList.add(STYLE_THEMES[newStyle]);

    body.style.opacity = 0.5;
    setTimeout(() => { body.style.opacity = 1; }, 200);
});


/* ===========================
    UPLOAD HANDLER (EXISTING)
=========================== */
document.getElementById("uploadBtn").onclick = async ()=>{
    const f = document.getElementById("songFile").files[0];
    if (!f) return alert("Pick a file");

    let fd = new FormData();
    fd.append("file", f);

    try {
        let r = await fetch(API + "/upload/song", {method:"POST", body:fd});
        let j = await r.json();
        songPath = j.path;
        alert("Upload OK! Song Path: " + songPath);
    } catch(err) {
        alert("Upload failed. Ensure backend is running at " + API);
    }
};

/* ===========================
    HELPER ‚Üí GET AUTOTUNE MODE (EXISTING)
=========================== */
function getAutotuneMode() {
    const radios = document.getElementsByName("autotune");
    for (const r of radios) if (r.checked) return r.value;
    return "medium";
}

/* ===========================
    RUN PIPELINE
=========================== */

function updateProgress(percent, message) {
    progressContainer.style.display = 'block';
    progressFill.style.width = `${percent}%`;
    progressText.textContent = message;

    if (percent >= 100) {
        setTimeout(() => { progressContainer.style.display = 'none'; }, 800);
    }
}

document.getElementById("runBtn").onclick = async ()=>{
    if (!songPath) return alert("Upload first!");
    document.getElementById("status").textContent = "running";
    updateProgress(0, "Analyzing Song..."); 

    let fd = new FormData();
    fd.append("song", songPath);
    fd.append("style", document.getElementById("styleSelect").value);
    fd.append("piano", document.getElementById("mixPiano").value);
    fd.append("guitar", document.getElementById("mixGuitar").value);
    fd.append("bass", document.getElementById("mixBass").value);
    fd.append("synth", document.getElementById("mixSynth").value);
    fd.append("drums", document.getElementById("mixDrums").value);
    fd.append("autotune_mode", getAutotuneMode());

    // --- MOCKING THE PROGRESS FOR DEMO ---
    let mockProgress = 0;
    const interval = setInterval(() => {
        mockProgress += Math.random() * 15;
        if (mockProgress > 100) mockProgress = 99; 
        updateProgress(mockProgress, `Converting... ${Math.floor(mockProgress)}%`);
    }, 700);
    // ------------------------------------

    let r = await fetch(API + "/run/arrange", { method:"POST", body:fd });
    clearInterval(interval); 
    updateProgress(100, "Conversion Complete!");

    let j = await r.json();

    const out = document.getElementById("output");
    out.innerHTML = "<strong>Generated Files:</strong><br><br>";

    // Simplified output generation
    let path = j.finals || j.instruments; 
    if (typeof path !== 'string' && path) path = path[Object.keys(path)[0]]; 
    
    if (path) {
         out.innerHTML += `
            <div><strong>Final Mix:</strong><br>
                <audio controls src="${API}/download?file=${encodeURIComponent(path)}"></audio>
            </div><br>
        `;
    } else {
        out.innerHTML += `<p>Conversion finished, but no files were returned. (Check backend logs)</p>`;
    }

    document.getElementById("status").textContent = "idle";
    
    // Setup Visualizer on first audio element
    const firstAudio = out.querySelector('audio');
    if (firstAudio) {
        firstAudio.onplay = () => setupAudioVisualizer(firstAudio);
    }
    
    // Show the "Rate the Chaos" popup
    setTimeout(() => {
        rateChaosPopup.style.display = 'grid';
    }, 1000); 
};

/* ===========================
    CHAOS RATING POPUP - CLOSING LOGIC (EXISTING)
=========================== */
document.querySelectorAll('.rate-option').forEach(option => {
    option.addEventListener('click', (e) => {
        rateChaosPopup.style.display = 'none';
        const rating = e.currentTarget.getAttribute('data-rating');
        console.log(`User rated chaos: ${rating}`);
    });
});
</script>

</body>
</html>